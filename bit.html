
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mycelium City — Mesh Workforce (Single‑File)</title>
  <meta name="description" content="One‑file workforce dashboard: create bots, post jobs, pay in MESH, trigger real‑world automations via webhooks." />
  <style>
    :root{
      --bg:#0b0f14; --panel:#121821; --muted:#7a8aa0; --ink:#e6f0ff; --ink-dim:#bcd0f0;
      --accent:#7dd3fc; --accent-2:#a78bfa; --ok:#86efac; --warn:#fde68a; --bad:#fca5a5;
      --shadow: 0 10px 24px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:radial-gradient(1200px 600px at 20% -10%,rgba(125,211,252,.08),transparent),
                 radial-gradient(1200px 600px at 120% 120%,rgba(167,139,250,.08),transparent),
                 var(--bg); color:var(--ink); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    header{
      position:sticky; top:0; backdrop-filter: blur(8px);
      background:linear-gradient(180deg, rgba(18,24,33,.85), rgba(18,24,33,.55));
      border-bottom:1px solid rgba(125,211,252,.12);
      z-index:10;
    }
    .wrap{max-width:1180px; margin:0 auto; padding:18px 16px}
    .brand{display:flex; align-items:center; gap:10px}
    .brand h1{font-size:20px; margin:0; letter-spacing:.3px}
    .brand .chip{font-size:12px; color:var(--bg); background:var(--accent); padding:4px 8px; border-radius:999px}
    .grid{
      display:grid; grid-template-columns:1.2fr 1fr; gap:16px; padding:20px 16px; max-width:1180px; margin:0 auto;
    }
    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,.02),rgba(255,255,255,.01));
      border:1px solid rgba(125,211,252,.12);
      border-radius:var(--radius); box-shadow:var(--shadow); padding:16px;
    }
    h2{font-size:16px; margin:0 0 10px 0; color:var(--ink)}
    .muted{color:var(--muted); font-size:12px}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    input,select,textarea,button{
      background:#0f1520; color:var(--ink); border:1px solid rgba(125,211,252,.16);
      border-radius:12px; padding:10px 12px; font:inherit;
    }
    input[type="number"]{width:120px}
    textarea{width:100%; min-height:90px; resize:vertical}
    button{cursor:pointer}
    button.primary{background:linear-gradient(180deg, #1a2536,#132032); border-color: rgba(125,211,252,.4)}
    button.ghost{background:transparent}
    button.good{border-color: rgba(34,197,94,.5)}
    button.bad{border-color: rgba(239,68,68,.5)}
    .pill{display:inline-flex; gap:6px; align-items:center; padding:4px 8px; border-radius:999px; border:1px solid rgba(125,211,252,.16); color:var(--ink-dim); font-size:12px}
    .list{display:flex; flex-direction:column; gap:10px; max-height:360px; overflow:auto; padding-right:6px}
    .item{display:flex; justify-content:space-between; align-items:flex-start; gap:10px; background:#0e1420; border:1px solid rgba(125,211,252,.12); padding:10px; border-radius:14px}
    .item h3{margin:0 0 4px 0; font-size:14px}
    .tiny{font-size:11px; color:var(--muted)}
    table{width:100%; border-collapse:collapse}
    th,td{border-bottom:1px dashed rgba(125,211,252,.12); padding:8px; text-align:left; vertical-align:top}
    th{font-size:12px; color:var(--ink-dim); font-weight:600}
    .kpis{display:grid; grid-template-columns: repeat(4, 1fr); gap:10px}
    .card{background:#0e1420; border:1px solid rgba(125,211,252,.12); padding:14px; border-radius:14px}
    .card h3{margin:0; font-size:13px; color:var(--ink-dim)}
    .card .big{font-size:20px; margin-top:6px}
    footer{max-width:1180px; margin:40px auto; padding:10px 16px; color:var(--muted)}
    .log{max-height:220px; overflow:auto; background:#0e1420; padding:10px; border-radius:12px; border:1px solid rgba(125,211,252,.12)}
    code{background:#0f1520; padding:2px 6px; border-radius:6px; border:1px solid rgba(125,211,252,.16)}
    .danger{color:#fca5a5}
    .success{color:#86efac}
    .warning{color:#fde68a}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
    .stack{display:flex; flex-direction:column; gap:8px}
    .side-note{font-size:12px; color:var(--muted); border-left:3px solid rgba(125,211,252,.22); padding-left:10px}
    .hr{height:1px; background:linear-gradient(90deg, rgba(125,211,252,.0), rgba(125,211,252,.2), rgba(125,211,252,.0)); margin:10px 0}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand">
        <div class="chip">LIVE</div>
        <h1>Mycelium City — Mesh Workforce</h1>
        <div class="pill"><span>Single‑file</span><span>LocalStorage</span><span>Webhook‑enabled</span></div>
      </div>
      <div class="muted">Run a virtual workforce, pay in <strong>MESH</strong>, and trigger real‑world automations via your own webhooks (Zapier/Make/AWS/etc.).
        <span class="danger">No illegal or deceptive automation. You are responsible for compliance and platform ToS.</span>
      </div>
    </div>
  </header>

  <main class="grid">
    <!-- LEFT: Workforce + Jobs -->
    <section class="panel">
      <h2>Workforce</h2>
      <div class="kpis">
        <div class="card"><h3>Bots</h3><div class="big" id="kpiBots">0</div></div>
        <div class="card"><h3>Jobs (Open)</h3><div class="big" id="kpiJobsOpen">0</div></div>
        <div class="card"><h3>MESH Supply</h3><div class="big mono" id="kpiMesh">0</div></div>
        <div class="card"><h3>USD (Recorded)</h3><div class="big mono" id="kpiUsd">$0.00</div></div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <input id="botCount" type="number" min="1" max="10000" value="10" />
        <button class="primary" id="btnCreateBots">Create Bots</button>
        <button class="ghost" id="btnNuke">Wipe All Data</button>
        <span class="muted">Tip: You can safely create thousands — the UI paginates.</span>
      </div>

      <div class="hr"></div>

      <div class="row">
        <select id="botFilter">
          <option value="all">All</option>
          <option value="idle">Idle</option>
          <option value="busy">Busy</option>
        </select>
        <input id="botSearch" placeholder="Search bots…" />
        <button id="btnExport" class="ghost">Export JSON</button>
        <label class="pill">
          Import
          <input id="importFile" type="file" accept="application/json" style="display:none">
        </label>
      </div>

      <div class="list" id="botList"></div>
    </section>

    <!-- RIGHT: Economy + Ledger + Integrations -->
    <section class="panel">
      <h2>Jobs & Economy</h2>

      <div class="stack">
        <strong>Create Job</strong>
        <div class="row">
          <input id="jobTitle" placeholder="Title e.g. Compile daily leads" style="flex:1">
          <input id="jobReward" type="number" min="0" step="1" value="10" title="MESH reward">
          <select id="jobProvider">
            <option value="webhook">Webhook</option>
            <option value="http-get">HTTP GET</option>
            <option value="none">Manual / Offline</option>
          </select>
        </div>
        <textarea id="jobDetails" placeholder="Job details (sent to provider)"></textarea>
        <div class="row">
          <input id="providerUrl" placeholder="Provider URL (e.g., your Zapier/Make/AWS webhook)" style="flex:1">
          <button id="btnAddJob" class="primary">Add Job</button>
        </div>
        <div class="side-note">
          Hook this into the real world by pasting a webhook/HTTP endpoint you control (Zapier/Make/AWS Lambda, Google Apps Script, your API). We’ll POST the job payload. Ensure CORS allows your domain.
        </div>
      </div>

      <div class="hr"></div>

      <div class="stack">
        <strong>USD Accounting (recorded)</strong>
        <div class="row">
          <input id="usdAmount" type="number" step="0.01" placeholder="Amount">
          <select id="usdType">
            <option value="deposit">Deposit</option>
            <option value="payout">Payout</option>
          </select>
          <input id="usdNote" placeholder="Note">
          <button id="btnUsd" class="primary">Record</button>
        </div>
        <div class="muted">This is a record only. For real payments, integrate a processor (e.g., Stripe) on your backend. This file does not move money.</div>
      </div>

      <div class="hr"></div>

      <div class="stack">
        <strong>Ledger</strong>
        <div class="log mono" id="ledgerView"></div>
      </div>

      <div class="hr"></div>

      <div class="stack">
        <strong>Audit Log</strong>
        <div class="log mono" id="auditView"></div>
      </div>
    </section>
  </main>

  <footer>
    <div class="side-note">
      This single file is production‑safe for a static host. Data persists in LocalStorage and can be exported/imported.
      Real‑world automations happen via your configured webhooks. Respect laws and platform terms; no spam, scraping, or deceptive behavior.
    </div>
  </footer>

<script>
/***
  Mycelium City — Mesh Workforce (Single‑File)
  ------------------------------------------------
  • Bots live in a virtual world and earn MESH for jobs.
  • Jobs can trigger real‑world automations via your own provider URLs.
  • USD entries are recorded for bookkeeping only (no payment rails here).
  • All data persists in LocalStorage; you can export/import JSON.
***/

const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);

const storeKey = "meshAppData.v1";
const defaultState = { bots:[], jobs:[], ledger:[], supply:{mesh:0}, usd:0, audit:[] };

let S = load();

function load(){
  try{ const raw = localStorage.getItem(storeKey); return raw ? JSON.parse(raw) : structuredClone(defaultState); }
  catch(e){ console.error(e); return structuredClone(defaultState); }
}
function save(){ localStorage.setItem(storeKey, JSON.stringify(S)); refresh(); }

function logAudit(msg){ S.audit.unshift({ id:uid(), at:new Date().toISOString(), msg }); if(S.audit.length>1000) S.audit.pop(); }

function fmtUsd(n){ return (n<0? "-":"") + "$" + Math.abs(n).toFixed(2); }
function fmt(n){ return new Intl.NumberFormat().format(n); }

// ---- Bots ----
function createBots(n){
  n = Math.max(1, Math.min(100000, n|0));
  const start = S.bots.length + 1;
  for(let i=0;i<n;i++){
    S.bots.push({ id:uid(), name:`MeshBot-${start+i}`, mesh:0, status:"idle", createdAt:Date.now(), stats:{jobsCompleted:0} });
  }
  logAudit(`Created ${n} bots.`);
  save();
}

function filteredBots(){
  const f = $("#botFilter").value;
  const q = $("#botSearch").value.trim().toLowerCase();
  let list = S.bots;
  if(f==="idle") list = list.filter(b=>b.status==="idle");
  if(f==="busy") list = list.filter(b=>b.status==="busy");
  if(q) list = list.filter(b => (b.name.toLowerCase().includes(q) || b.id.includes(q)));
  return list;
}

function renderBots(page=1, pageSize=50){
  const list = filteredBots();
  $("#kpiBots").textContent = fmt(S.bots.length);
  const el = $("#botList");
  el.innerHTML = "";
  if(list.length===0){ el.innerHTML = '<div class="muted">No bots yet. Create some above.</div>'; return; }

  const start = (page-1)*pageSize;
  const view = list.slice(start, start+pageSize);
  view.forEach(b=>{
    const wrap = document.createElement('div'); wrap.className="item";
    const left = document.createElement('div');
    left.innerHTML = `
      <h3>${b.name} <span class="tiny">#${b.id.slice(-5)}</span></h3>
      <div class="tiny">Status: <strong>${b.status}</strong> • MESH: <strong>${fmt(b.mesh)}</strong> • Jobs: ${fmt(b.stats.jobsCompleted)}</div>
      <div class="row" style="margin-top:6px">
        <button data-act="assign" data-id="${b.id}" class="primary">Assign Job</button>
        <button data-act="pay" data-id="${b.id}" class="good">Pay MESH</button>
        <button data-act="idle" data-id="${b.id}" class="ghost">Set Idle</button>
        <button data-act="del" data-id="${b.id}" class="bad">Delete</button>
      </div>
    `;
    wrap.append(left);
    el.append(wrap);
  });

  // Pagination controls
  const pages = Math.ceil(list.length / pageSize);
  if(pages>1){
    const nav = document.createElement('div'); nav.className="row"; nav.style.marginTop="6px";
    for(let p=1;p<=pages;p++){
      const btn = document.createElement('button');
      btn.textContent = (p===page? `• ${p} •` : `${p}`);
      btn.addEventListener('click', ()=> renderBots(p));
      nav.append(btn);
    }
    el.append(nav);
  }

  // Delegate actions
  el.onclick = async (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    const id = btn.getAttribute('data-id'); const act = btn.getAttribute('data-act');
    const bot = S.bots.find(x=>x.id===id); if(!bot) return;

    if(act==="assign"){ await assignJobToBot(bot); }
    if(act==="pay"){
      const amount = parseInt(prompt("MESH amount to pay?", "10")||"0",10);
      if(amount>0){ payMesh(bot, amount, `Manual pay on ${new Date().toLocaleString()}`); }
    }
    if(act==="idle"){ bot.status="idle"; save(); }
    if(act==="del"){
      if(confirm("Delete this bot? This cannot be undone.")){
        S.bots = S.bots.filter(x=>x.id!==id);
        save();
      }
    }
  };
}

// ---- Jobs ----
function addJob(){
  const title = $("#jobTitle").value.trim();
  const details = $("#jobDetails").value.trim();
  const reward = Math.max(0, parseInt($("#jobReward").value||"0",10));
  const provider = $("#jobProvider").value;
  const url = $("#providerUrl").value.trim();

  if(!title){ alert("Job needs a title."); return; }
  if(provider!=="none" && !url){ alert("Provide your webhook/HTTP URL to trigger."); return; }

  const job = { id:uid(), title, details, meshReward:reward, provider, url, status:"queued", createdAt:Date.now(), result:null, assignedTo:null };
  S.jobs.push(job);
  logAudit(`Job queued: ${title} [${job.id.slice(-5)}]`);
  save();
}

function nextOpenJob(){ return S.jobs.find(j=>j.status==="queued"); }

async function assignJobToBot(bot){
  const job = nextOpenJob();
  if(!job){ alert("No queued jobs."); return; }
  if(bot.status==="busy"){ alert("Bot is already busy."); return; }

  job.assignedTo = bot.id;
  job.status = "running"; save();
  bot.status = "busy"; save();

  try{
    const payload = {
      jobId: job.id, title: job.title, details: job.details, reward: job.meshReward,
      bot: { id: bot.id, name: bot.name }, ts: Date.now(), note:"Mycelium Mesh job dispatch"
    };
    let resp, text;

    if(job.provider==="webhook"){
      const ctrl = new AbortController(); setTimeout(()=>ctrl.abort(), 30000);
      resp = await fetch(job.url, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload), signal: ctrl.signal });
      text = await resp.text();
    } else if(job.provider==="http-get"){
      const q = new URL(job.url);
      q.searchParams.set("jobId", job.id);
      q.searchParams.set("title", job.title);
      q.searchParams.set("details", job.details);
      q.searchParams.set("reward", job.meshReward);
      q.searchParams.set("botId", bot.id);
      resp = await fetch(q.toString(), { method:"GET" });
      text = await resp.text();
    } else {
      // Manual/offline: mark as done without network
      text = "Manual/offline completion recorded.";
    }

    job.result = { ok:true, at:Date.now(), status: resp? resp.status: 200, body: text.slice(0, 8000) };
    job.status = "done"; bot.status = "idle"; bot.stats.jobsCompleted++;
    if(job.meshReward>0){ payMesh(bot, job.meshReward, `Job reward for ${job.title}`); }
    logAudit(`Job done: ${job.title} (${job.id.slice(-5)}) by ${bot.name}`);
    save();
  }catch(err){
    job.result = { ok:false, at:Date.now(), error: String(err) };
    job.status = "failed"; bot.status = "idle";
    logAudit(`Job failed: ${job.title} (${job.id.slice(-5)}) • ${String(err)}`);
    save();
  }
}

// ---- Economy ----
function mintMesh(amount, note="Mint"){
  amount = Math.max(0, amount|0);
  S.supply.mesh += amount;
  S.ledger.unshift({ id:uid(), ts:Date.now(), type:"MESH_MINT", amount, note });
}

function payMesh(bot, amount, note="Pay"){
  amount = Math.max(0, amount|0);
  if(S.supply.mesh < amount){ mintMesh(amount, "Auto‑mint for pay"); }
  S.supply.mesh -= amount;
  bot.mesh += amount;
  S.ledger.unshift({ id:uid(), ts:Date.now(), type:"MESH_PAY", amount, botId:bot.id, botName:bot.name, note });
  save();
}

// ---- USD bookkeeping ----
function recordUsd(kind, amount, note){
  amount = parseFloat(amount||"0");
  if(!(amount>0)) return;
  if(kind==="deposit"){ S.usd += amount; S.ledger.unshift({ id:uid(), ts:Date.now(), type:"USD_DEPOSIT", amount, note }); }
  if(kind==="payout"){ S.usd -= amount; S.ledger.unshift({ id:uid(), ts:Date.now(), type:"USD_PAYOUT", amount:-amount, note }); }
  logAudit(`USD ${kind}: ${amount} • ${note||""}`);
  save();
}

// ---- Rendering ----
function renderKPIs(){
  $("#kpiJobsOpen").textContent = fmt(S.jobs.filter(j=>j.status==="queued"||j.status==="running").length);
  $("#kpiMesh").textContent = fmt(S.supply.mesh);
  $("#kpiUsd").textContent = fmtUsd(S.usd);
}
function renderLedger(){
  const out = S.ledger.slice(0,200).map(e=>{
    const t = new Date(e.ts).toLocaleString();
    if(e.type.startsWith("USD")){
      return `[${t}] ${e.type}: ${e.amount>=0?"+":""}${fmtUsd(e.amount)} — ${e.note||""}`;
    }else if(e.type==="MESH_MINT"){
      return `[${t}] ${e.type}: +${fmt(e.amount)} MESH — ${e.note||""}`;
    }else{
      return `[${t}] ${e.type}: -${fmt(e.amount)} MESH to ${e.botName||e.botId||"?"} — ${e.note||""}`;
    }
  }).join("\n");
  $("#ledgerView").textContent = out || "No entries yet.";
}
function renderAudit(){
  $("#auditView").textContent = (S.audit.slice(0,200).map(a=>`[${new Date(a.at).toLocaleString()}] ${a.msg}`).join("\n")) || "No activity yet.";
}

function refresh(){
  renderKPIs(); renderBots(); renderLedger(); renderAudit();
}

// ---- Export / Import ----
function exportData(){
  const blob = new Blob([JSON.stringify(S,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "mesh_workforce_backup.json";
  a.click(); URL.revokeObjectURL(url);
}
function importData(file){
  const reader = new FileReader();
  reader.onload = () => {
    try{ S = JSON.parse(reader.result); save(); }
    catch(e){ alert("Invalid file."); }
  };
  reader.readAsText(file);
}

// ---- Events ----
$("#btnCreateBots").onclick = ()=> createBots(parseInt($("#botCount").value||"1",10));
$("#btnNuke").onclick = ()=> { if(confirm("Wipe ALL data?")){ localStorage.removeItem(storeKey); S = structuredClone(defaultState); save(); } };
$("#botFilter").onchange = refresh;
$("#botSearch").oninput = ()=> renderBots(1);
$("#btnAddJob").onclick = addJob;
$("#btnUsd").onclick = ()=> recordUsd($("#usdType").value, $("#usdAmount").value, $("#usdNote").value);
$("#btnExport").onclick = exportData;
$("#importFile").onchange = e => { const f = e.target.files[0]; if(f) importData(f); };

// Bootstrap
if(!S.ledger.length){ mintMesh(1000, "Genesis"); logAudit("Genesis mint 1000 MESH."); }
save(); // normalize + render
</script>
</body>
</html>